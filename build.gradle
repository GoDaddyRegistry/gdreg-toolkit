buildscript {
    repositories {
        mavenCentral()
        jcenter()
    }
}

plugins {
    id 'com.github.ben-manes.versions' version '0.11.3'
    id 'org.sonarqube' version '2.8'
    id 'maven-publish'
}

apply plugin: 'java'
apply plugin: 'maven'
apply plugin: "org.sonarqube"
apply plugin: 'jacoco'

ext {
    junitVersion = '4.11'
    artifactsDir = "$projectDir/artifacts"
    artifactGroupId = 'godaddy.registry'
    pagesProjectDir = "$projectDir/../godaddyregistry.github.io"
    checkstyleConfDirPath = "$projectDir/checkstyle/"

    commonsCodecVersion          = '1.10'
    simpleFrameworkVersion       = '4.1.21'
    httpClientVersion            = '4.5.1'
    powerMockVersion             = '1.6.3'
    hamcrestVersion              = '1.3'
    ariMockHttpServerVersion     = '1.0.2'
    jacocoVersion                = '0.8.4'
}

version = toolkitVersion
group = artifactGroupId

repositories {
    mavenCentral()
    flatDir name:'ExternalJars',dirs:'lib'
}

sourceSets {
    test {
        java.srcDir('src/test/unit/java')
        resources.srcDir('src/test/unit/resources')
    }
    componentTest {
        java.srcDir('src/test/component/java')
        resources.srcDir('src/test/component/resources')
    }
    integrationTest {
        java.srcDir('src/test/integration/java')
        resources.srcDir('src/test/integration/resources')
    }
}

dependencies {
    compile("commons-codec:commons-codec:$commonsCodecVersion") {
        exclude group: 'junit', module: 'junit'
    }

    compile "org.apache.httpcomponents:httpclient:$httpClientVersion"

    testCompile "org.hamcrest:hamcrest-all:$hamcrestVersion"
    testCompile "org.simpleframework:simple:$simpleFrameworkVersion"
    testCompile("org.powermock:powermock-api-mockito:$powerMockVersion") {
        exclude module: 'junit'
    }
    testCompile("org.powermock:powermock-module-junit4:$powerMockVersion") {
        exclude module: 'junit'
    }
    testCompile ("junit:junit-dep:$junitVersion") {
        exclude group: 'org.hamcrest', module: 'hamcrest-core' // exclude hamcrest-core 1.3
    }

    integrationTestCompile sourceSets.main.output
    integrationTestCompile configurations.testCompile

    componentTestCompile sourceSets.main.output
    componentTestCompile configurations.testCompile
    componentTestCompile "au.com.ausregistry:ari-mock-http-server:$ariMockHttpServerVersion"

    jacocoAgent "org.jacoco:org.jacoco.agent:${project.jacoco.toolVersion}"
}

tasks.withType(JavaCompile) {
    sourceCompatibility = '1.8'
    targetCompatibility = '1.8'

    options.encoding = "UTF-8"
    options.compilerArgs << "-Xlint:-options"
}

tasks.withType(Test) {
    jvmArgs += ['-Dfile.encoding=UTF8', '-Duser.timezone=UTC']
    jacoco {
        enabled = true
    }
}

task cleanArtifacts(type: Delete) {
    delete artifactsDir
}

test {
    outputs.upToDateWhen { false }
    exclude '**/PerfTest.class'
    exclude '**/SessionTest.class'
    exclude '**/SessionManagerTest.class'
}

// Configure javadoc task not to generate timestamp in HTML comment
tasks.withType(Javadoc) {
    options.noTimestamp(true)
}
javadoc {
    destinationDir = file("$artifactsDir/javadoc")
}

clean.dependsOn cleanArtifacts

test.dependsOn jar

task integrationTest(type: Test) {
    testClassesDirs = sourceSets.integrationTest.output.classesDirs
    reports.junitXml.destination = file("$buildDir/test-results/integration")
    classpath += sourceSets.integrationTest.runtimeClasspath
}

task componentTest(type: Test) {
    onlyIf { // on Travis if runtime is JDK6 it would complain about major.minor version of MockHttpServer
        isJava8Compatible()
    }

    testClassesDirs = sourceSets.componentTest.output.classesDirs
    reports.junitXml.destination = file("$buildDir/test-results/component")
    classpath += sourceSets.componentTest.runtimeClasspath
    classpath += sourceSets.componentTest.runtimeClasspath
}

jar {
    manifest {
        attributes('Specification-Title': 'gdreg java toolkit',
        'Specification-Version': "${version}",
        'Implementation-Version': "${version}",
        "Implementation-Timestamp": new Date())
    }
}

task sourcesJar(type: Jar, dependsOn:classes) {
    classifier = 'sources'
    from sourceSets.main.allSource
}

task javadocJar(type: Jar, dependsOn:javadoc) {
    classifier = 'javadoc'
    from javadoc.destinationDir
}

task checkVersionNumbersInReadme {

  doLast {
    def readme = file("readme.md")
    def looksLikeVersionNumber = ~/\d+\.\d+\.\d+/
    def textNeedFixedVersion = 'Since version 3.7.6 the toolkit no longer support Java SE 6.'

    def versionNumbersInReadmeFile = readme.readLines()
        .findAll { line ->
            !line.startsWith(textNeedFixedVersion)
        }
        .collectMany { line ->
            looksLikeVersionNumber.matcher(line).collect { match ->
                (toolkitVersion == match) ? null : match
            }.findResults{ x -> x }
        }

    def decommissionJava6LineWithFixedVersion = readme.readLines().find {line ->
        line.startsWith(textNeedFixedVersion)
    }

    assert versionNumbersInReadmeFile.isEmpty()
    assert decommissionJava6LineWithFixedVersion != null
  }
}

artifacts {
    archives sourcesJar
    archives javadocJar
}

// Deprecated, use publish tasks instead
uploadArchives {
    uploadDescriptor = false
    repositories {
        flatDir {
            dirs artifactsDir
        }
        if (System.properties.keySet().containsAll('repoUrl', 'repoUsername', 'repoPassword')) {
            mavenDeployer {
                repository(url: System.properties['repoUrl']) {
                    authentication(userName: System.properties['repoUsername'], password: System.properties['repoPassword'])
                }
                pom.groupId = artifactGroupId
                pom.artifactId = rootProject.name
                pom.version = toolkitVersion
            }
        } else {
            mavenDeployer {
                repository(url: "file://$pagesProjectDir/repo")
                pom.groupId = artifactGroupId
                pom.artifactId = rootProject.name
                pom.version = toolkitVersion
            }
        }
    }
}

uploadArchives {
  doLast {
    if (!System.properties.keySet().containsAll('repoUrl', 'repoUsername', 'repoPassword')) {
        copy {
            from(javadoc.destinationDir)
            into "$pagesProjectDir/javadoc/gdreg-toolkit"
        }
    }
  }
}

uploadArchives.dependsOn checkVersionNumbersInReadme, javadoc

publishing {
    publications {
        gdrjtk(MavenPublication) {
            from components.java
            artifact sourcesJar
            artifact javadocJar
        }
    }
    repositories {
        // Have to use System.properties['prop'] instead of "$prop"!
        // Otherwise it will throw error due to unknown property
        maven {
            name = "GitHubPackages"
            url = System.properties['repoUrl']
            credentials {
                username = System.properties['repoUsername']
                password = System.properties['repoPassword']
            }
        }
    }
}


integrationTest.dependsOn test
componentTest.dependsOn integrationTest

apply plugin: 'checkstyle'

checkstyle {
    configFile = file(checkstyleConfDirPath + 'checkstyle.xml')
    configProperties = [checkstyleConfigDir: checkstyleConfDirPath]
    toolVersion = "6.19"
}

tasks.withType(Checkstyle) {
    onlyIf { // on Travis if runtime is JDK6 it would complain about major.minor version of Checkstyle tool
        isJava8Compatible()
    }

    classpath = project.sourceSets.main.output
    classpath += configurations.compile
    classpath += configurations.testCompile
    classpath += configurations.integrationTestCompile
}

check.dependsOn test
check.dependsOn integrationTest
check.dependsOn componentTest

boolean isJava8Compatible() {
    JavaVersion.current().java8Compatible
}

jacoco {
    toolVersion = jacocoVersion
}

task jacocoMerge(type: JacocoMerge) {
    destinationFile = file("$buildDir/jacoco/merged.exec")
    executionData = project.fileTree(dir: "$buildDir", include:'jacoco/*.exec', exclude:'jacoco/merged.exec')
}

jacocoTestReport {
    executionData = files("$buildDir/jacoco/merged.exec")
    reports {
        xml.enabled true
        csv.enabled true
        html.enabled true
    }
}

jacocoMerge.dependsOn componentTest
jacocoTestReport.dependsOn jacocoMerge
project.tasks["sonarqube"].dependsOn jacocoTestReport

sonarqube {
    properties {
        property "sonar.coverage.jacoco.xmlReportPaths", "${buildDir}/reports/jacoco/test/jacocoTestReport.xml"
        property "sonar.host.url", "http://sonar.dev.reg.neustar.com/"
        property "sonar.projectVersion", "$version"
    }
}
